---
title: 语雀云端写作
urlname: bghlql
date: "2023-08-12 11:11:51"
updated: "2023-08-29 23:47:22"
author: ql-isaac
trans: Writing_on_The_Cloud_With_YuQue
cover: "https://img.imql.life/Working-rafiki.png"
tags:
  - elog
categories:
  - 我的博客
---

语雀云端写作实现了 Markdown 格式的博文与博客构建目录的分离，这样的话，我想同时使用多少个主题都是没有问题的了，更重要的事，可以完全实现静态博客在线编辑。

<!-- more -->

{% note primary %}
本文对于文件（代码）变动的描述方式为`-`指删掉该行，`+`指增加改行（如果你是直接复制此行，请注意删掉`+`和上下文对齐），`...`表示省略上下文。另外，本文对于文件（代码）变动的描述只针对当时的文件（代码）版本，请根据实际情况决定对自己的相应文件（代码）进行变动。
{% endnote %}

## 博文迁移

[首先是注册语雀账号](https://www.yuque.com/login?platform=wechat&inviteToken=f6e959505e77f114312173f53ec62f7b8996ef80b543c7af96cf3f987a7b91e4)，登陆上后，新建知识库，名称就为个人博客，再点击右上方的新建，选择导入，选择 Markdown 格式，将本地博文（即 \_post 下的 Markdown 文件）批量（按住 Ctrl 可多选）导入至知识库个人博客。
导入成功后会发现每篇博文的开头，即 front-matter 部分有点乱，可以参看下图说明更正一下。
![更正 front-matter](https://img.imql.life/illustrations/ac2ddcd3949a2858339eef3443e4719d.png "更正 front-matter")

## 安装 Elog

[Elog](https://github.com/LetTTGACO/elog)，一个开放式跨端博客解决方案，可以随意组合写作平台（语雀/Notion/FlowUs）和博客平台（Hexo/Vitepress/Confluence/WordPress）等，是本次实现语雀云端写作的关键。
{% note primary %}
本着非必要不升级的原则，我使用的 Node.js 一直以来都是 v12.14.0，本次安装使用的 Elog 要求至少 14 版本的 Node.js，故而我升级 Node.js 到最新的 LTS 版本，即 18 版本。
{% endnote %}
全局安装 @elog/cli：

```bash
npm install -g @elog/cli
```

进入<博客构建目录>，执行以下命令进行初始化，会在根目录生成一份配置文件 elog.config.js 和本地调试用的环境变量文件 .elog.env。

```bash
elog init
```

## 本地调试

将 .elog.env 加入 .gitignore，防止密码等信息提交：

```diff
.DS_Store
Thumbs.db
db.json
*.log
public/
node_modules/
.deploy*/
+.elog.env
```

### 配置

编辑 .elog.env，配置语雀认证的环境变量：

```diff
# 语雀（Token方式）
YUQUE_TOKEN=
# 语雀（帐号密码方式）
YUQUE_USERNAME=
YUQUE_PASSWORD=
YUQUE_LOGIN=
YUQUE_REPO=
```

{% note info %}
Token 方式和帐号密码方式二选一，现在使用 Token 需要开会员，没有会员的就使用帐号密码方式吧。YUQUE_LOGIN 和 YUQUE_REPO 的获取方式见 [elog 官方文档的关键信息获取](https://elog.1874.cool/notion/gvnxobqogetukays#%E8%AF%AD%E9%9B%80)。
{% endnote %}
再配置图床认证的环境变量，平台可在腾讯云、阿里云、又拍云、七牛云和 GitHub 中选择一个，详细配置方式见 [elog 官方文档的关键信息获取](https://elog.1874.cool/notion/gvnxobqogetukays#%E5%9B%BE%E5%BA%8A)。
编辑 elog.config.js，设置写作平台为 yuque-pwd：

```diff
...
write: {
-     platform: "yuque"
+    platform: "yuque-pwd",
...
```

配置本地部署方式：

```diff
...
deploy: {
    platform: "local",
    local: {
-      outputDir: "./docs",
+      outputDir: "source/_posts",
      filename: "title",
-      format: "markdown",
+      format: "matter-markdown",
      catalog: false,
      formatExt: "",
    },
...
```

开启图床，设置图床平台：

```diff
...
image: {
-    enable: false,
+    enable: true
-    platform: "local",
+    platform: "<图床平台>",
...
```

最后配置图床为腾讯云、阿里云、又拍云、七牛云或 GitHub，配置方式见 [elog 官方文档的配置详情](https://elog.1874.cool/notion/fe8ywmt999gon12w#%E5%9B%BE%E5%BA%8A%E5%B9%B3%E5%8F%B0)。

### 同步

```bash
elog sync -e .elog.env
```

如果日志显示同步成功，本地调试即成功。

## 持续集成

本地安装 @elog/cli：

```bash
npm install @elog/cli
```

为了防止 hexo 在生成博客源文件时报错，新建目录 cache，将 elog.cache.json 移动过去。
编辑 package.json，新建一个 NPM 命令用于同步：

```diff
...
"scripts": {
    "build": "hexo generate",
    "clean": "hexo clean",
    "deploy": "hexo deploy",
    "server": "hexo server",
+    "sync": "elog sync -a cache/elog.cache.json"
  },
...
```

前往博客构建仓库添加密钥，如下图，添加 YUQUE_TOKEN(YUQUE_USERNAME、YUQUE_PASSWORD)、YUQUE_LOGIN、YUQUE_REPO 的值，再添加图床的密钥，如使用腾讯云作为图床平台，还需添加 COS_SECRET_ID、COS_SECRET_KEY、COS_BUCKET、COS_REGION 和 COS_HOST 的值。
![添加密钥](https://img.imql.life/illustrations/90710f82bec002595dbc8594e8ccbea4.png "添加密钥")
编辑 GitHub Actions 工作流：

```diff
name: hexo-build
on:
  push:
    branches:
      - main
env:
  TZ: Asia/Shanghai
jobs:
  www-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
      - name: Install Node.js lts/Hydrogen
        uses: actions/setup-node@v3
        with:
          node-version: "lts/Hydrogen"
          cache: "npm"
      - name: Cache dependencies
        uses: actions/cache@v3
        id: cache-dependencies
        with:
          path: node_modules
          key: ${{runner.OS}}-${{hashFiles('**/package-lock.json')}}
      - name: Install dependencies
        if: steps.cache-dependencies.outputs.cache-hit != 'true'
        run: npm ci
+      - name: Pull posts from Yuque
+        env:
+          YUQUE_TOKEN: ${{ secrets.YUQUE_TOKEN }}
+          YUQUE_LOGIN: ${{ secrets.YUQUE_LOGIN }}
+          YUQUE_REPO: ${{ secrets.YUQUE_REPO }}
+          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
+          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
+          COS_BUCKET: ${{ secrets.COS_BUCKET }}
+          COS_REGION: ${{ secrets.COS_REGION }}
+          COS_HOST: ${{ secrets.COS_HOST }}
+        run: |
+          npm run sync
      - name: Setup private rsa key
        env:
          DEPLOY_KEY: ${{secrets.DEPLOY_KEY}}
        run: |
          mkdir -p ~/.ssh/
          echo "$DEPLOY_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts
      - name: Deploy
        run: |
          git config --global user.name "${{secrets.GIT_NAME}}"
          git config --global user.email "${{secrets.GIT_EMAIL}}"
          npm run build -d
+      - name: Upload Cache for next workflow to use
+        uses: actions/upload-artifact@v3
+        with:
+          name: "Cache"
+          path: cache
+          retention-days: 90
+      - name: Upload Posts for next workflow to use
+        uses: actions/upload-artifact@v3
+        with:
+          name: "Posts"
+          path: "source/_posts"
+          retention-days: 90
```

提交：

```diff
git add .
git commit -m ":green_heart: 使用elog实现语雀云端写作"
```

编辑 GitHub Actions 工作流：

```diff
name: hexo-build
on:
  push:
    branches:
      - main
+  repository_dispatch:
+    types:
+      - publish
env:
  TZ: Asia/Shanghai
jobs:
  www-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
      - name: Install Node.js lts/Hydrogen
        uses: actions/setup-node@v3
        with:
          node-version: "lts/Hydrogen"
          cache: "npm"
      - name: Cache dependencies
        uses: actions/cache@v3
        id: cache-dependencies
        with:
          path: node_modules
          key: ${{runner.OS}}-${{hashFiles('**/package-lock.json')}}
      - name: Install dependencies
        if: steps.cache-dependencies.outputs.cache-hit != 'true'
        run: npm ci
+      - name: Download Posts from the last workflow
+        uses: dawidd6/action-download-artifact@v2
+        with:
+          github_token: ${{secrets.GITHUB_TOKEN}}
+          name: "Posts"
+          path: "source/_posts"
+      - name: Download Cache from the last workflow
+        uses: dawidd6/action-download-artifact@v2
+        with:
+          github_token: ${{secrets.GITHUB_TOKEN}}
+          name: "Cache"
+          path: "cache"
      - name: Pull posts from Yuque
        env:
          YUQUE_TOKEN: ${{ secrets.YUQUE_TOKEN }}
          YUQUE_LOGIN: ${{ secrets.YUQUE_LOGIN }}
          YUQUE_REPO: ${{ secrets.YUQUE_REPO }}
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
          COS_HOST: ${{ secrets.COS_HOST }}
        run: |
          npm run sync
      - name: Setup private rsa key
        env:
          DEPLOY_KEY: ${{secrets.DEPLOY_KEY}}
        run: |
          mkdir -p ~/.ssh/
          echo "$DEPLOY_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts
      - name: Deploy
        run: |
          git config --global user.name "${{secrets.GIT_NAME}}"
          git config --global user.email "${{secrets.GIT_EMAIL}}"
          npm run build && npm run deploy
      - name: Upload Cache for next workflow to use
        uses: actions/upload-artifact@v3
        with:
          name: "Cache"
          path: cache
          retention-days: 90
      - name: Upload Posts for next workflow to use
        uses: actions/upload-artifact@v3
        with:
          name: "Posts"
          path: "source/_posts"
          retention-days: 90

```

将 source 下 \_posts 和 cache 下的 elog.cache.json 加入 .gitignore 并删除掉，这两个地方的文件已经不需要。
最终提交：

```diff
git add .
git commit -m ":green_heart: 使用elog实现语雀云端写作（终）"
```

这样，在语雀上写好博文并更新，只需要地址栏输入以下地址（外部事件触发 API），即可触发持续集成，实现云端写作。

```
https://serverless-api-elog.vercel.app/api/github?user=<自己GitHub用户名>&repo=<博客构建仓库名>&event_type=publish&token=<自己生成的Token>
```

{% note success %}
生成 Token 的方式（勾选 repo 的权限）：
![image.png](https://img.imql.life/illustrations/00a92719a9a976b6a2a985afec041d27.png)
{% endnote %}
以上 API 是 elog 官方在 Vercel 上搭建的，使用的 Vercel 默认域名，会经常被墙，我们可以自己搭建一个并且使用上自己的域名（未备案也行，因为 Vercel 是国外服务）。
fork [serverless-api](https://github.com/LetTTGACO/serverless-api)，[登录 Vercel](https://vercel.com/dashboard)，新建，导入刚刚 fork 的项目，部署。到域名设置那里，添加自己的域名，如 publish.xxx.xx，再到域名供应商那里添加一下 cname 解析，最后回到域名设置那里，确认解析生效，这样，将以上地址中域名替换为自己的域名得到自己的 API。
